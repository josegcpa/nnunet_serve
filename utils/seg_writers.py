import re
import random
import logging
import highdicom as hd
import numpy as np
import pydicom
import pydicom_seg
import SimpleITK as sitk
from tqdm import tqdm
from pathlib import Path
from dataclasses import dataclass
from pydicom.sr.codedict import codes, Code
from pydicom.sr._concepts_dict import concepts as CONCEPTS
from .logging_utils import get_logger

logger = get_logger(__name__)

CATEGORY_MAPPING = {
    "type": {
        "248300009": "85756007",
        "12402003": "85756007",
        "39937001": "85756007",
        "71616004": "85756007",
        "74135004": "85756007",
        "13024002": "85756007",
        "52082005": "85756007",
        "21793004": "85756007",
        "59820001": "91723000",
        "20982000": "85756007",
        "51114001": "91723000",
        "29092000": "91723000",
        "87612001": "85756007",
        "59441001": "91723000",
        "89890002": "85756007",
        "83555006": "85756007",
        "85756007": "309825002",
        "113343008": "85756007",
        "272673000": "85756007",
        "309312004": "85756007",
        "119410002": "85756007",
        "4147007": "49755003",
        "27925004": "49755003",
        "367643001": "49755003",
        "75753009": "49755003",
        "55584005": "49755003",
        "79654002": "49755003",
        "50960005": "49755003",
        "23583003": "49755003",
        "44132006": "49755003",
        "6574001": "49755003",
        "86049000": "49755003",
        "14799000": "49755003",
        "108369006": "49755003",
        "74947009": "91720002",
        "39477002": "91720002",
        "70150004": "91720002",
        "78014005": "91720002",
        "32457005": "91720002",
        "111175": "260787004",
        "112171": "260787004",
        "112172": "260787004",
        "112173": "260787004",
        "112174": "260787004",
        "112175": "260787004",
        "112176": "260787004",
        "112177": "260787004",
        "112178": "260787004",
        "122485": "260787004",
        "272180002": "260787004",
        "262301009": "260787004",
        "228761004": "260787004",
        "53350007": "260787004",
        "40388003": "260787004",
        "19443004": "260787004",
        "272287005": "260787004",
        "360129009": "260787004",
        "25510005": "260787004",
        "27606000": "260787004",
        "129460009": "260787004",
        "102304005": "260787004",
        "129463006": "260787004",
        "14106009": "260787004",
        "118378005": "260787004",
        "72506001": "260787004",
        "286558002": "260787004",
        "360066001": "260787004",
        "77444004": "260787004",
        "68183006": "260787004",
        "77720000": "260787004",
        "63562005": "260787004",
        "27065002": "260787004",
        "56353002": "260787004",
        "257409000": "260787004",
        "129467007": "260787004",
        "86407004": "260787004",
        "26412008": "260787004",
        "65818007": "260787004",
        "102312002": "260787004",
        "102313007": "260787004",
        "102314001": "260787004",
        "102315000": "260787004",
        "102316004": "260787004",
        "25062003": "260787004",
        "126065006": "260787004",
        "19923001": "260787004",
        "102317008": "260787004",
        "102319006": "260787004",
        "102320000": "260787004",
        "79068005": "260787004",
        "86122002": "260787004",
        "102378009": "260787004",
        "80919006": "260787004",
        "38586004": "260787004",
        "57126000": "260787004",
        "19227008": "260787004",
        "48387007": "260787004",
        "15A": "91723000",
        "16A": "91723000",
        "20A": "91723000",
        "21A": "91723000",
        "22A": "91723000",
        "28A": "91723000",
        "29A": "91723000",
        "9": "91723000",
        "112054": "91723000",
        "112085": "91723000",
        "112086": "91723000",
        "112087": "91723000",
        "112088": "91723000",
        "112089": "91723000",
        "112090": "91723000",
        "112091": "91723000",
        "112092": "91723000",
        "112093": "91723000",
        "112094": "91723000",
        "112095": "91723000",
        "112102": "91723000",
        "112103": "91723000",
        "113681": "91723000",
        "276650": "91723000",
        "128981007": "91723000",
        "118375008": "91723000",
        "111289009": "91723000",
        "128551005": "91723000",
        "253276007": "91723000",
        "128570000": "91723000",
        "128572008": "91723000",
        "128563000": "91723000",
        "45503006": "91723000",
        "70142008": "91723000",
        "61959006": "91723000",
        "83330001": "91723000",
        "128555001": "91723000",
        "128556000": "91723000",
        "128557009": "91723000",
        "128558004": "91723000",
        "128584005": "91723000",
        "128566008": "91723000",
        "128567004": "91723000",
        "128568009": "91723000",
        "131183008": "91723000",
        "396339007": "91723000",
        "107671003": "91723000",
        "417437006": "91723000",
        "416152001": "91723000",
        "416319003": "91723000",
        "416550000": "91723000",
        "416775004": "91723000",
        "416949008": "91723000",
        "416631005": "91723000",
        "74160004": "91723000",
        "75093004": "91723000",
        "76752008": "91723000",
        "77831004": "91723000",
        "19100000": "91723000",
        "76365002": "91723000",
        "33564002": "91723000",
        "110517009": "91723000",
        "89546000": "91723000",
        "55024004": "91723000",
        "74872008": "91723000",
        "24924006": "91723000",
        "60911003": "91723000",
        "59066005": "91723000",
        "31640002": "91723000",
        "74386004": "91723000",
        "73117003": "91723000",
        "52374004": "91723000",
        "6229007": "91723000",
        "51283005": "91723000",
        "13881006": "91723000",
        "70925003": "91723000",
        "91609006": "91723000",
        "21387005": "91723000",
        "91397008": "91723000",
        "56873002": "91723000",
        "26493002": "91723000",
        "50016007": "91723000",
        "113197003": "91723000",
        "421060004": "91723000",
        "122494005": "91723000",
        "122495006": "91723000",
        "122496007": "91723000",
        "51282000": "91723000",
        "54735007": "91723000",
        "64688005": "91723000",
        "79601000": "91723000",
        "51299004": "91723000",
        "22356005": "91723000",
        "85050009": "91723000",
        "72001000": "91723000",
        "71341001": "91723000",
        "64234005": "91723000",
        "87342007": "91723000",
        "80144004": "91723000",
        "58742003": "91723000",
        "22688005": "91723000",
        "81727001": "91723000",
        "22823000": "91723000",
        "50755001": "91723000",
        "30608006": "91723000",
        "6423006": "91723000",
        "72573008": "91723000",
        "51159009": "91723000",
        "1193009": "91723000",
        "90588001": "91723000",
        "35259002": "91723000",
        "195879000": "91723000",
        "44947003": "91723000",
        "57651003": "91723000",
        "88340001": "91723000",
        "4317002": "91723000",
        "60005003": "91723000",
        "18686000": "91723000",
        "372074006": "91723000",
        "18346003": "91723000",
        "73930003": "91723000",
        "24062007": "91723000",
        "64658001": "91723000",
        "53967007": "91723000",
        "31764008": "91723000",
        "15665001": "91723000",
        "41313007": "91723000",
        "88454005": "91723000",
        "102292000": "91723000",
        "39352004": "91723000",
        "79361005": "91723000",
        "53620006": "91723000",
        "85856004": "91723000",
        "16953009": "91723000",
        "74670003": "91723000",
        "7844006": "91723000",
        "39723000": "91723000",
        "24136001": "91723000",
        "70258002": "91723000",
        "27949001": "91723000",
        "368536000": "91723000",
        "8361002": "91723000",
        "61695000": "91723000",
        "30180000": "91723000",
        "89187006": "91723000",
        "312535008": "91723000",
        "45206002": "91723000",
        "53342003": "91723000",
        "87166008": "91723000",
        "2095001": "91723000",
        "360955006": "91723000",
        "18962004": "91723000",
        "4596009": "91723000",
        "44567001": "91723000",
        "28700002": "91723000",
        "955009": "91723000",
        "70074004": "91723000",
        "75245000": "91723000",
        "39607008": "91723000",
        "46750007": "91723000",
        "86598002": "91723000",
        "72674008": "91723000",
        "72481006": "91723000",
        "31094006": "91723000",
        "45653009": "91723000",
        "90572001": "91723000",
        "3120008": "91723000",
        "113257007": "91723000",
        "80891009": "91723000",
        "59652004": "91723000",
        "58095006": "91723000",
        "128586007": "91723000",
        "73829009": "91723000",
        "68300000": "91723000",
        "82471001": "91723000",
        "33626005": "91723000",
        "21814001": "91723000",
        "589001": "91723000",
        "118755002": "91723000",
        "53085002": "91723000",
        "128565007": "91723000",
        "8017000": "91723000",
        "44627009": "91723000",
        "87878005": "91723000",
        "128564006": "91723000",
        "70238003": "91723000",
        "13418002": "91723000",
        "102298001": "91723000",
        "46030003": "91723000",
        "39057004": "91723000",
        "90315007": "91723000",
        "91134007": "91723000",
        "34202007": "91723000",
        "76848001": "91723000",
        "25489000": "91723000",
        "91747007": "91723000",
        "281159003": "91723000",
        "264293000": "91723000",
        "299716001": "91723000",
        "15825003": "91723000",
        "113262008": "91723000",
        "54247002": "91723000",
        "57034009": "91723000",
        "88593004": "91723000",
        "2160002": "91723000",
        "32672002": "91723000",
        "7832008": "91723000",
        "41801008": "91723000",
        "244251006": "91723000",
        "244252004": "91723000",
        "76862008": "91723000",
        "3227004": "91723000",
        "59438005": "91723000",
        "68787002": "91723000",
        "36672000": "91723000",
        "91748002": "91723000",
        "91750005": "91723000",
        "91751009": "91723000",
        "91752002": "91723000",
        "57396003": "91723000",
        "52433000": "91723000",
        "6511003": "91723000",
        "75902001": "91723000",
        "57823005": "91723000",
        "91760001": "91723000",
        "91753007": "91723000",
        "91754001": "91723000",
        "91755000": "91723000",
        "91756004": "91723000",
        "91757008": "91723000",
        "91758003": "91723000",
        "91759006": "91723000",
        "13647002": "91723000",
        "91083009": "91723000",
        "41879009": "91723000",
        "56789007": "91723000",
        "53655008": "91723000",
        "12800002": "91723000",
        "91761002": "91723000",
        "91762009": "91723000",
        "91763004": "91723000",
        "22765000": "91723000",
        "81040000": "91723000",
        "128589000": "91723000",
        "79142001": "91723000",
        "45341000": "91723000",
        "78480002": "91723000",
        "50408007": "91723000",
        "69105007": "91723000",
        "32062004": "91723000",
        "22286001": "91723000",
        "72021004": "91723000",
        "113264009": "91723000",
        "23074001": "91723000",
        "31145008": "91723000",
        "15672000": "91723000",
        "86117002": "91723000",
        "43119007": "91723000",
        "53549008": "91723000",
        "59749000": "91723000",
        "128979005": "91723000",
        "88556005": "91723000",
        "11279006": "91723000",
        "8012006": "91723000",
        "85234005": "91723000",
        "17388009": "91723000",
        "59011009": "91723000",
        "12691009": "91723000",
        "36765005": "91723000",
        "6538005": "91723000",
        "3159004": "91723000",
        "91732003": "91723000",
        "69327007": "91723000",
        "3924000": "91723000",
        "206034008": "91723000",
        "64468002": "91723000",
        "38991005": "91723000",
        "57850000": "91723000",
        "76015000": "91723000",
        "22083002": "91723000",
        "86570000": "91723000",
        "42258001": "91723000",
        "33795007": "91723000",
        "2841007": "91723000",
        "10293006": "91723000",
        "73634005": "91723000",
        "90024005": "91723000",
        "113269004": "91723000",
        "29660000": "91723000",
        "34635009": "91723000",
        "67937003": "91723000",
        "17137000": "91723000",
        "44984001": "91723000",
        "45631007": "91723000",
        "7657000": "91723000",
        "69833005": "91723000",
        "113270003": "91723000",
        "128559007": "91723000",
        "43899006": "91723000",
        "13363002": "91723000",
        "8821006": "91723000",
        "68053000": "91723000",
        "34340008": "91723000",
        "360592004": "91723000",
        "12123001": "91723000",
        "32114007": "91723000",
        "9454009": "91723000",
        "72107004": "91723000",
        "90219004": "91723000",
        "5928000": "91723000",
        "194996006": "91723000",
        "195416006": "91723000",
        "128585006": "91723000",
        "8629005": "91723000",
        "113273001": "91723000",
        "43863001": "91723000",
        "51249003": "91723000",
        "122972007": "91723000",
        "48345005": "91723000",
        "8887007": "91723000",
        "64131007": "91723000",
        "8993003": "91723000",
        "56400007": "91723000",
        "32764006": "91723000",
        "284639000": "91723000",
        "110568007": "91723000",
        "128583004": "91723000",
        "35819009": "91723000",
        "46027005": "91723000",
        "63507001": "91723000",
        "68705008": "91723000",
        "128553008": "91723000",
        "20699002": "91723000",
        "20115005": "91723000",
        "83419000": "91723000",
        "128548003": "91723000",
        "128554002": "91723000",
        "128560002": "91723000",
        "60734001": "91723000",
        "128569001": "91723000",
        "123851003": "91723000",
        "49460000": "91723000",
        "48477009": "91723000",
        "21974007": "91723000",
        "38199008": "91723000",
        "54066008": "91723000",
        "81502006": "91723000",
        "32849002": "91723000",
        "69695003": "91723000",
        "30315005": "91723000",
        "38848004": "91723000",
        "21306003": "91723000",
        "34516001": "91723000",
        "14742008": "91723000",
        "71854001": "91723000",
        "60184004": "91723000",
        "110612005": "91723000",
        "34402009": "91723000",
        "53505006": "91723000",
        "28273000": "91723000",
        "385294005": "91723000",
        "45289007": "91723000",
        "54019009": "91723000",
        "10200004": "91723000",
        "28231008": "91723000",
        "15776009": "91723000",
        "69930009": "91723000",
        "110621006": "91723000",
        "122489005": "91723000",
        "431491007": "91723000",
        "64033007": "91723000",
        "25990002": "91723000",
        "2334006": "91723000",
        "87953007": "91723000",
        "89837001": "91723000",
        "48367006": "91723000",
        "13648007": "91723000",
        "86969008": "91723000",
        "87759004": "91723000",
        "45292006": "91723000",
        "76784001": "91723000",
        "35039007": "91723000",
        "71252005": "91723000",
        "15497006": "91723000",
        "31435000": "91723000",
        "110639002": "91723000",
        "90418005": "91723000",
        "38242008": "91723000",
        "18911002": "91723000",
        "41216001": "91723000",
        "64739004": "91723000",
        "40689003": "91723000",
        "57671007": "91723000",
        "20233005": "91723000",
        "279215006": "91723000",
        "21483005": "91723000",
        "389080008": "91723000",
        "389081007": "91723000",
        "12738006": "91723000",
        "87563008": "91723000",
        "11628009": "91723000",
        "280371009": "91723000",
        "3058005": "91723000",
        "427667007": "91723000",
        "128320002": "91723000",
        "84782009": "91723000",
        "65216001": "91723000",
        "1231004": "91723000",
        "18545000": "91723000",
        "75042008": "91723000",
        "23180006": "91723000",
        "35951006": "91723000",
        "35764002": "91723000",
        "66720007": "91723000",
        "49841001": "91723000",
        "80447000": "91723000",
        "35918002": "91723000",
        "40146001": "91723000",
        "68523003": "91723000",
        "83251001": "91723000",
        "16630005": "91723000",
        "31065004": "91723000",
        "78277001": "91723000",
        "5366008": "91723000",
        "3937002": "91723000",
        "36169008": "91723000",
        "88442005": "91723000",
        "89202009": "91723000",
        "26230003": "91723000",
        "37035000": "91723000",
        "55233005": "91723000",
        "70105001": "91723000",
        "87463005": "91723000",
        "31428008": "91723000",
        "11000004": "91723000",
        "4958002": "91723000",
        "89278009": "91723000",
        "14738005": "91723000",
        "42695009": "91723000",
        "279336005": "91723000",
        "61962009": "91723000",
        "70007007": "91723000",
        "30114003": "91723000",
        "113305005": "91723000",
        "33060004": "91723000",
        "11089000": "91723000",
        "33723005": "91723000",
        "67701001": "91723000",
        "2748008": "91723000",
        "12958003": "91723000",
        "27088001": "91723000",
        "461002": "91723000",
        "25238003": "91723000",
        "244453006": "91723000",
        "53238003": "91723000",
        "88882009": "91723000",
        "36582005": "91723000",
        "53520000": "91723000",
        "44909008": "91723000",
        "81745001": "91723000",
        "18619003": "91723000",
        "28726007": "91723000",
        "79652003": "91723000",
        "80243003": "91723000",
        "117590005": "91723000",
        "28347008": "91723000",
        "84301002": "91723000",
        "25342003": "91723000",
        "22945000": "91723000",
        "361078006": "91723000",
        "56329008": "91723000",
        "62818001": "91723000",
        "37512009": "91723000",
        "45793000": "91723000",
        "23451007": "91723000",
        "51345006": "91723000",
        "69748006": "91723000",
        "111002": "91723000",
        "78961009": "91723000",
        "1732005": "91723000",
        "9875009": "91723000",
        "38266002": "91723000",
        "312779009": "91723000",
        "91830000": "91723000",
        "297171002": "91723000",
        "297172009": "91723000",
        "297173004": "91723000",
        "272710004": "91723000",
        "66019005": "91723000",
        "278983006": "91723000",
        "119238007": "91723000",
        "120576005": "91723000",
        "280401006": "91723000",
        "281130003": "91723000",
        "371398005": "91723000",
        "371195002": "91723000",
        "774007": "91723000",
        "69536005": "91723000",
        "41695006": "91723000",
        "89545001": "91723000",
        "60819002": "91723000",
        "661005": "91723000",
        "1101003": "91723000",
        "42575006": "91723000",
        "363654007": "91723000",
        "45048000": "91723000",
        "5713008": "91723000",
        "170887008": "91723000",
        "77621008": "91723000",
        "77568009": "91723000",
        "16982005": "91723000",
        "52612000": "91723000",
        "58602004": "91723000",
        "133943005": "91723000",
        "133944004": "91723000",
        "46862004": "91723000",
        "38864007": "91723000",
        "51185008": "91723000",
        "281134007": "91723000",
        "91691001": "91723000",
        "5076001": "91723000",
        "72410000": "91723000",
        "5798000": "91723000",
        "280062008": "91723000",
        "113345001": "91723000",
        "52731004": "91723000",
        "50519007": "91723000",
        "48544008": "91723000",
        "86367003": "91723000",
        "68505006": "91723000",
        "27947004": "91723000",
        "19695001": "91723000",
        "133945003": "91723000",
        "133946002": "91723000",
        "90290004": "91723000",
        "11708003": "91723000",
        "15425007": "91723000",
        "83670000": "91723000",
        "113346000": "91723000",
        "27398004": "91723000",
        "82849001": "91723000",
        "12921003": "91723000",
        "21844003": "91723000",
        "34411009": "91723000",
        "450960006": "91723000",
        "26893007": "91723000",
        "37117007": "91723000",
        "85119005": "91723000",
        "53120007": "91723000",
        "91470000": "91723000",
        "40983000": "91723000",
        "14975008": "91723000",
        "85562004": "91723000",
        "7569003": "91723000",
        "76505004": "91723000",
        "61685007": "91723000",
        "68367000": "91723000",
        "72696002": "91723000",
        "128587003": "91723000",
        "32361000": "91723000",
        "30021000": "91723000",
        "56459004": "91723000",
        "29707007": "91723000",
        "110726009": "91723000",
        "110837003": "91723000",
        "110861005": "91723000",
        "50536004": "91723000",
        "14944004": "91723000",
        "91707000": "91723000",
        "371863001": "246464006",
        "7140000": "105590001",
        "112082": "309825002",
        "112083": "309825002",
        "112084": "309825002",
        "113132": "309825002",
        "125040": "309825002",
        "125041": "309825002",
        "C94970": "309825002",
        "289925000": "309825002",
    },
    "modifier": {
        "24028007": "91723000",
        "7771000": "91723000",
        "51440002": "91723000",
    },
}


def random_color_generator():
    r = random.randint(0, 255)
    g = random.randint(0, 255)
    b = random.randint(0, 255)
    return (r, g, b)


def one_hot_encode(arr: np.ndarray, n_labels: int) -> np.ndarray:
    """
    Converts a numpy array to a one-hot encoded numpy array.

    Args:
        arr (np.ndarray): numpy array to be converted.

    Returns:
        np.ndarray: one-hot encoded numpy array.
    """
    output_arr = np.zeros([*arr.shape, n_labels])
    for i in range(n_labels):
        output_arr[..., i] = arr == i
    return output_arr


def save_mask_as_rtstruct(
    img_data: np.ndarray,
    dcm_reference_file: str,
    output_path: str,
    segment_info: list[tuple[str, list[int]]],
) -> None:
    """
    Converts a numpy array to an RT (radiotherapy) struct object. Could be a
        multi-class object (each n > 0 corresponds to a class). The number of
        classes corresponds to ``np.unique(img_data).shape[0] - 1``.

    Args:
        img_data (np.ndarray): numpy array with n non-zero unique values, each
            of which corresponds to a class.
        dcm_reference_file (str): reference DICOM files.
        output_path (str): output file for RT struct file.
        segment_info (tuple[str, list[int]]): segment information. Should be a
            list with size equal to the number of classes, and each element
            should be a tuple whose first element is the segment description
            and the second element a list of RGB values.
    """
    try:
        from rt_utils import RTStructBuilder
    except ImportError:
        raise ImportError(
            "rt_utils is required to save masks in RT struct format"
        )
    # based on the TotalSegmentator implementation

    logging.basicConfig(level=logging.WARNING)  # avoid messages from rt_utils

    # create new RT Struct - requires original DICOM
    rtstruct = RTStructBuilder.create_new(dicom_series_path=dcm_reference_file)

    # retrieve selected classes
    img_data = img_data.swapaxes(0, 2)
    selected_classes = np.unique(img_data)
    selected_classes = selected_classes[selected_classes > 0].tolist()
    if len(selected_classes) == 0:
        return None

    # add mask to RT Struct
    for class_idx in tqdm(selected_classes):
        class_name, class_colour = segment_info[class_idx - 1]
        binary_img = img_data == class_idx
        if binary_img.sum() > 0:  # only save none-empty images
            # add segmentation to RT Struct
            rtstruct.add_roi(
                mask=binary_img,  # has to be a binary numpy array
                name=class_name,
                color=class_colour,
            )

    rtstruct.save(str(output_path))


@dataclass
class SegWriter:
    segment_names: list[str | dict[str, str]]
    algorithm_name: str
    algorithm_version: str = "v1.0"
    algorithm_family: pydicom.sr.coding.Code = (
        codes.cid7162.ArtificialIntelligence
    )
    algorithm_type: hd.seg.SegmentAlgorithmTypeValues = (
        hd.seg.SegmentAlgorithmTypeValues.AUTOMATIC
    )
    instance_number: int = 1
    series_number: int = 999
    manufacturer: str = "Algorithm"
    manufacturer_model_name: str = "AlgorithmModel"
    series_description: str = "Segmentation"
    clinical_trial_series_id: str = "1"
    clinical_trial_time_point_id: str = "1"
    body_part_examined: str = "BODY"

    def __post_init__(self):
        self.segment_descriptions = []
        category_concepts = codes.cid7150.concepts
        self.algorithm_identification = hd.AlgorithmIdentificationSequence(
            name=self.algorithm_name,
            version=self.algorithm_version,
            family=self.algorithm_family,
        )
        for i, segment in enumerate(self.segment_names):
            if isinstance(segment, dict):
                segment_name = self.process_name(segment["name"])
                segment_number = segment.get("number", i + 1)
                segment_label = segment.get("label", segment["name"])
                tracking_id = segment.get(
                    "tracking_id", f"Segment{segment_number}_{segment_label}"
                )
            elif isinstance(segment, str):
                segment_name = self.process_name(segment)
                segment_number = i + 1
                segment_label = segment
                tracking_id = f"Segment{segment_number}_{segment_label}"
            else:
                raise ValueError(f"Invalid segment: {segment}")
            type_code_dict = CONCEPTS["SCT"][segment_name]
            type_code_number = list(type_code_dict.keys())[0]
            type_code_name, _ = type_code_dict[type_code_number]
            type_code = Code(
                value=type_code_number,
                meaning=type_code_name,
                scheme_designator="SCT",
            )

            category_number = CATEGORY_MAPPING["type"][type_code.value]
            category_code = [
                category_concepts[k]
                for k in category_concepts
                if category_concepts[k].value == category_number
            ][0]

            segment_description = hd.seg.SegmentDescription(
                segment_number=segment_number,
                segment_label=segment_label,
                segmented_property_category=category_code,
                segmented_property_type=type_code,
                algorithm_type=self.algorithm_type,
                algorithm_identification=self.algorithm_identification,
                tracking_uid=hd.UID(),
                tracking_id=tracking_id,
            )
            self.segment_descriptions.append(segment_description)

    def process_name(self, name: str) -> str:
        name = re.sub("[ ]*[lL]eft[ ]*", "", name)
        name = re.sub("[ ]*[rR]ight[ ]*", "", name)
        name = name.strip()
        return name

    def to_array_if_necessary(
        self, mask: np.ndarray | sitk.Image
    ) -> np.ndarray:
        if isinstance(mask, sitk.Image):
            mask = sitk.GetArrayFromImage(mask)
        return mask

    def write_dicom_seg(
        self,
        mask_array: np.ndarray | sitk.Image,
        source_files: list[str],
        output_path: str,
        is_fractional: bool = False,
    ):
        mask_array = self.to_array_if_necessary(mask_array)

        if len(mask_array.shape) != 4:
            mask_array = one_hot_encode(
                mask_array, len(self.segment_descriptions)
            )
        image_datasets = [hd.imread(str(f)) for f in source_files]

        if hasattr(image_datasets[0], "InstanceNumber"):
            image_datasets = sorted(
                image_datasets, key=lambda x: x.InstanceNumber
            )
        elif hasattr(image_datasets[0], "ImagePositionPatient"):
            image_datasets = sorted(
                image_datasets, key=lambda x: float(x.ImagePositionPatient[2])
            )

        first = image_datasets[0]
        rows, cols = int(getattr(first, "Rows")), int(getattr(first, "Columns"))
        frames = len(image_datasets)
        if (frames, rows, cols) != mask_array.shape[:-1]:
            raise Exception(
                f"Mask shape {mask_array.shape} does not match image shape {frames}x{rows}x{cols}"
            )
        if mask_array.shape[-1] != len(self.segment_descriptions):
            raise Exception(
                f"Mask shape {mask_array.shape} does not match number of segments {len(self.segment_descriptions)}"
            )

        # Create the Segmentation instance
        segmented_objects_text = ", ".join(
            [s.SegmentLabel for s in self.segment_descriptions]
        )
        if is_fractional:
            seg_type = hd.seg.SegmentationTypeValues.FRACTIONAL
        else:
            seg_type = hd.seg.SegmentationTypeValues.BINARY
        seg_dataset = hd.seg.Segmentation(
            source_images=image_datasets,
            pixel_array=mask_array,
            segmentation_type=seg_type,
            segment_descriptions=self.segment_descriptions,
            series_instance_uid=hd.UID(),
            series_number=999,
            sop_instance_uid=hd.UID(),
            instance_number=1,
            manufacturer=self.manufacturer,
            manufacturer_model_name=self.manufacturer_model_name,
            software_versions=self.algorithm_version,
            device_serial_number="42",
            series_description=f"Segmentation of {segmented_objects_text}",
        )
        seg_dataset.ClinicalTrialSeriesID = self.clinical_trial_series_id
        seg_dataset.ClinicalTrialTimePointID = self.clinical_trial_time_point_id
        seg_dataset.BodyPartExamined = self.body_part_examined

        seg_dataset.save_as(output_path)

        return "success"

    def write_dicom_rtstruct(
        self,
        mask_array: np.ndarray | sitk.Image,
        source_files: list[str],
        output_path: str,
    ):
        mask_array = self.to_array_if_necessary(mask_array)
        segment_info = [
            [s.SegmentLabel, list(random_color_generator())]
            for s in self.segment_descriptions
        ]
        save_mask_as_rtstruct(
            mask_array,
            Path(source_files[0]).parent,
            output_path,
            segment_info,
        )

        return "success"

    @staticmethod
    def init_from_dcmqi_metadata_file(
        metadata_file: str,
        algorithm_version: str = "v1.0",
        manufacturer: str = "Algorithm",
        manufacturer_model_name: str = "AlgorithmModel",
    ):
        metadata = pydicom_seg.template.from_dcmqi_metainfo(metadata_file)
        segments = list(metadata.SegmentSequence)
        algorithm_name = segments[0].SegmentAlgorithmName
        algorithm_type = hd.seg.SegmentAlgorithmTypeValues[
            segments[0].SegmentAlgorithmType
        ]
        series_description = metadata.SeriesDescription
        clinical_trial_series_id = metadata.ClinicalTrialSeriesID
        clinical_trial_time_point_id = metadata.ClinicalTrialTimePointID
        body_part_examined = metadata.BodyPartExamined
        return SegWriter(
            segment_names=segments,
            algorithm_name=algorithm_name,
            algorithm_version=algorithm_version,
            algorithm_family=codes.cid7162.ArtificialIntelligence,
            algorithm_type=algorithm_type,
            instance_number=1,
            series_number=999,
            series_description=series_description,
            manufacturer=manufacturer,
            manufacturer_model_name=manufacturer_model_name,
            clinical_trial_series_id=clinical_trial_series_id,
            clinical_trial_time_point_id=clinical_trial_time_point_id,
            body_part_examined=body_part_examined,
        )

    @staticmethod
    def init_from_metadata_dict(metadata: dict[str, str]):
        print(metadata)
        if "path" in metadata:
            return SegWriter.init_from_dcmqi_metadata_file(metadata["path"])
        else:
            return SegWriter(**metadata)


if __name__ == "__main__":
    seg_writer = SegWriter(
        segment_names=[{"name": "Liver", "number": 1, "label": "Liver"}],
        algorithm_name="nnUNet",
        algorithm_version="v1.0",
    )

    print(seg_writer.segment_descriptions)
